# Day Six - Configuring Kubernetes to use OIDC

---

In this section we will ..

---


```console
cd /Users/desdrury/Sites/ThirdParty/k8s-vagrant-multi-node
vagrant ssh
sudo su -

# Put in the cert generated with onessl
vi /etc/ssl/certs/ca.crt


vi /etc/kubernetes/manifests/kube-apiserver.yaml

    - --oidc-issuer-url=https://keycloak-http/auth/realms/kube7days
    - --oidc-username-claim=preferred_username
    - --oidc-username-prefix=-
    - --oidc-groups-claim=groups
    - --oidc-client-id=kubernetes
    - --oidc-ca-file=/etc/ssl/certs/ca.crt
```

```console
kubectl -n kube-system get pod -l component=kube-apiserver
```

```console
NAME                    READY     STATUS    RESTARTS   AGE
kube-apiserver-master   1/1       Running   0          1m
```

Login

```console
cd ~/tmp/onessl/
k8s-auth --client-secret 41602dd9-3a2b-47e6-9927-c09ed3095e36 --client-id kubernetes --issuer https://keycloak.192.168.26.11.nip.io/auth/realms/kube7days --debug --issuer-root-ca ca.crt
```

Then use `kubectl config` to create a new context.

```yaml
- context:
    cluster: k8s-vagrant-multi-node
    namespace: kube-system
    user: kube7days@packt.com
  name: k8s-vagrant-multi-node-oidc

- name: kube7days@packt.com
  user:
    auth-provider:
      config:
        client-id: kubernetes
        client-secret: 41602dd9-3a2b-47e6-9927-c09ed3095e36
        id-token: eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI5Z1c5Sml3ZXRlTDVaNGNsWll6a2o0Xzl5TDAtQWY5ME5NdFJhTnJZYk80In0.eyJqdGkiOiJmZjBjOWEwMy1iMmQwLTRkNjUtOTYxYi00OWUxMTJmM2Y2NDgiLCJleHAiOjE1MzM3OTQyMjEsIm5iZiI6MCwiaWF0IjoxNTMzNzkzOTIxLCJpc3MiOiJodHRwczovL2tleWNsb2FrLjE5Mi4xNjguMjYuMTEubmlwLmlvL2F1dGgvcmVhbG1zL2t1YmU3ZGF5cyIsImF1ZCI6Imt1YmVybmV0ZXMiLCJzdWIiOiJhOWY1NjI5NC1kNjc1LTQ5ZDAtYjBmMi1iYjJlYTk3MmI5ZTgiLCJ0eXAiOiJJRCIsImF6cCI6Imt1YmVybmV0ZXMiLCJhdXRoX3RpbWUiOjE1MzM3OTM5MjEsInNlc3Npb25fc3RhdGUiOiJkNDI5Mjk0NC1iZGNjLTRlZTctOGE2Ni1lY2NjYWE4YzE0YzQiLCJhY3IiOiIxIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsImdyb3VwcyI6WyIvYWRtaW4iXSwicHJlZmVycmVkX3VzZXJuYW1lIjoia3ViZTdkYXlzIiwiZW1haWwiOiJrdWJlN2RheXNAcGFja3QuY29tIn0.J2yNNtDybg8ioWwxazIebOIzB2PWyffxeZnr8KmRgWcB2RuEW-y6k1iUdze1al4_aKj5Kn3gtaCafMWV6GVLAn2puja37oRmUJRVGKN54G-_VO3kqNz1uuqmBxBSCnqM-nMODhIUkv68yyHEtQCiMVUzi6ye22B3RNJcQsGmetjc2qepiOmqWOgfza7ccmqNVtO_L0FvJezV1nrdoQjDAhDsaWnimfgZiTV4l58ozP72yu37rYQPf5gDgMGoJ4OywiAu8LgcWCB-2I1cq3GDKbw0Y7HeRZsDkvKS2o9EF3yuPEsN-PRz4BGyeR8FBmN_sIxERROqhS4UVJ_C5-HlXQ
        idp-certificate-authority: /Users/desdrury/tmp/onessl/ca.crt
        idp-issuer-url: https://keycloak.192.168.26.11.nip.io/auth/realms/kube7days
        refresh-token: eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI5Z1c5Sml3ZXRlTDVaNGNsWll6a2o0Xzl5TDAtQWY5ME5NdFJhTnJZYk80In0.eyJqdGkiOiIwYWQxMjI1ZS1jNTYwLTQ2NTEtYTExNS0yZmM3YjNmZmRiNDQiLCJleHAiOjAsIm5iZiI6MCwiaWF0IjoxNTMzNzkzOTIxLCJpc3MiOiJodHRwczovL2tleWNsb2FrLjE5Mi4xNjguMjYuMTEubmlwLmlvL2F1dGgvcmVhbG1zL2t1YmU3ZGF5cyIsImF1ZCI6Imt1YmVybmV0ZXMiLCJzdWIiOiJhOWY1NjI5NC1kNjc1LTQ5ZDAtYjBmMi1iYjJlYTk3MmI5ZTgiLCJ0eXAiOiJPZmZsaW5lIiwiYXpwIjoia3ViZXJuZXRlcyIsImF1dGhfdGltZSI6MCwic2Vzc2lvbl9zdGF0ZSI6ImQ0MjkyOTQ0LWJkY2MtNGVlNy04YTY2LWVjY2NhYThjMTRjNCIsInJlYWxtX2FjY2VzcyI6eyJyb2xlcyI6WyJvZmZsaW5lX2FjY2VzcyIsInVtYV9hdXRob3JpemF0aW9uIl19LCJyZXNvdXJjZV9hY2Nlc3MiOnsiYWNjb3VudCI6eyJyb2xlcyI6WyJtYW5hZ2UtYWNjb3VudCIsIm1hbmFnZS1hY2NvdW50LWxpbmtzIiwidmlldy1wcm9maWxlIl19fSwic2NvcGUiOiJvcGVuaWQgZW1haWwgb2ZmbGluZV9hY2Nlc3MgcHJvZmlsZSJ9.ZuFclzI5kB1aM5-EiDBcBiwVm23jVpge47jaJSHCTqBp5uFfE2LER0iLzgWrdszvV_73xQ0mztSLeiFidm8CQEFf7KANLy_709gxkcm00EYgbqaAwTfl7VoXcqIgs--lNx8i37VnmqWgdoDwidBiEFW4W6J7FM-B5OYfVNJ1whQmpvDDCP_1Eb5fzedY5uXfUdQJpLOIZv409QlGT2f-q4_0hsOjCpShK9MRXB3YWX3_KBqEhzwJpkknA6wpL1PbdgP_RM6V3VGFp2TF5Sciw4hNI01a4gmgP3q6TCmigjL_-YGjorlDUSuS1gG9op-Fvz6Fk1knFcB_3R-Ox4sUXw
      name: oidc
```



What we have done in this section is ...


## Scratch


# Next

In the next section we will ....

[Next](06-05.md)
